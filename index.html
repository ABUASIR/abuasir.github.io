<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>تخطي تحديد السرعة</title>

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0e0f12; --card:#15171b; --text:#e9edf3; --muted:#9aa3b2;
      --line:#2a2f39; --accent:#22d3ee;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:#0e0f12;
      color:var(--text);
      font-family:"Tajawal",sans-serif;
      display:flex;
      justify-content:center;
      align-items:center;
      flex-direction:column;
      height:100vh;
      text-align:center;
    }
    .panel{
      background:#15171b;
      border:1px solid var(--line);
      border-radius:14px;
      padding:20px;
      box-shadow:0 0 15px rgba(0,0,0,.5);
      text-align:center;
      width:360px;
      margin-bottom:25px;
    }
    button{
      background:#0f131a;
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 16px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      margin:6px;
      transition:.2s;
    }
    button:hover{border-color:#3a4454}
    button.active{border-color:var(--accent);color:var(--accent);}
    .inputish{
      /* أخفيت الحقل الأصلي حسب المطلوب */
      display:none;
    }

    /* صندوق العد التنازلي الجديد */
    .count-box{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      background:linear-gradient(180deg, rgba(30,34,40,0.9), rgba(16,18,22,0.9));
      border:1px solid var(--line);
      padding:10px 14px;
      border-radius:10px;
      margin:6px auto;
      min-width:160px;
    }
    .count-number{
      font-size:1.6rem;
      font-weight:800;
      width:54px;
      text-align:center;
      color:var(--text);
    }
    .count-label{
      color:var(--muted);
      font-size:.95rem;
    }

    .muted{color:var(--muted);font-size:.95rem;margin-top:12px}
  </style>
</head>
<body>

  <div class="panel">
    <button id="toggleBtn">تشغيل</button>

    <!-- الحقل الأصلي مُخفى، لكنه يُبقى قيمة افتراضية يمكن تعديلها في الكود -->
    <div class="inputish">
      كل <input id="intervalSec" type="number" min="1" value="5"> ثوان
    </div>

    <!-- صندوق العد التنازلي الظاهر بدل الحقل -->
    <div class="count-box" aria-live="polite">
      <div class="count-label">كل</div>
      <div id="countdown" class="count-number">5</div>
      <div class="count-label">ثوان</div>
    </div>

    <div class="muted">تخطي تحديد السرعة</div>
  </div>

  <script>
    /********* الإعدادات الأساسية *********/
    const urls = [
      "https://speedtest.saudi.net.sa:8080/speedtest/upload.php",
      "https://khamismushait-speedtest.saudi.net.sa:8080/speedtest/upload.php",
      "https://dam-speedtest.saudi.net.sa:8080/speedtest/upload.php",
      "https://jed-speedtest.saudi.net.sa:8080/speedtest/upload.php",
      "https://bahrah-speedtest.saudi.net.sa:8080/speedtest/upload.php",
      "https://makkah-speedtest.saudi.net.sa:8080/speedtest/upload.php",
      "https://taif-speedtest.saudi.net.sa:8080/speedtest/upload.php",
      "https://abha-speedtest.saudi.net.sa:8080/speedtest/upload.php",
      "https://baha-speedtest.saudi.net.sa:8080/speedtest/upload.php"
    ];
    const TIMEOUT_MS = 10000;

    /********* عناصر DOM *********/
    const toggleBtn = document.getElementById("toggleBtn");
    const intervalSecInput = document.getElementById("intervalSec"); // مخفي لكن نستخدم قيمته
    const countdownEl = document.getElementById("countdown");

    /********* حالات المؤقت *********/
    let running = false;
    let checkHandle = null;   // handle لـ setInterval(checkAll,...)
    let tickHandle = null;    // handle للعد التنازلي (كل ثانية)
    let remaining = Number(intervalSecInput.value) || 5; // الثواني المتبقية

    // عرض القيمة الابتدائية في المربع عند تحميل الصفحة
    countdownEl.textContent = remaining;

    /********* دالة ping بسيطة *********/
    async function ping(url){
      const controller = new AbortController();
      const t0 = performance.now();
      const timer = setTimeout(()=>controller.abort(), TIMEOUT_MS);
      try{
        await fetch(url, { method: "GET", mode: "no-cors", cache: "no-store", signal: controller.signal });
        return { ok: true, ms: Math.round(performance.now() - t0) };
      } catch {
        return { ok: false, ms: Math.round(performance.now() - t0) };
      } finally {
        clearTimeout(timer);
      }
    }

    /********* نفّذ الفحوصات على كل السيرفرات *********/
    async function checkAll(){
      // عند كل فحص نعيد ضبط العداد إلى قيمة الـ interval
      const sec = Math.max(1, Number(intervalSecInput.value) || 5);
      remaining = sec;
      updateCountdownDisplay();

      for(const u of urls){
        const { ok, ms } = await ping(u);
        console.log(`${ok ? "✅" : "❌"} ${u} (${ms} ms)`);
      }
    }

    /********* تحديث عرض العداد *********/
    function updateCountdownDisplay(){
      countdownEl.textContent = String(remaining);
    }

    /********* مؤقت العد (يعمل كل ثانية ليعرض التناقص) *********/
    function startTick(){
      // امنع تكرار الـtick
      if(tickHandle) clearInterval(tickHandle);
      tickHandle = setInterval(()=>{
        if(remaining > 0){
          remaining -= 1;
          updateCountdownDisplay();
        } else {
          // عند وصول 0 نرجع للـ interval (انتظار الفحص التالي)
          const sec = Math.max(1, Number(intervalSecInput.value) || 5);
          remaining = sec;
          updateCountdownDisplay();
        }
      }, 1000);
    }

    function stopTick(){
      if(tickHandle){ clearInterval(tickHandle); tickHandle = null; }
    }

    /********* start / stop *********/
    function start(){
      const sec = Math.max(1, Number(intervalSecInput.value) || 5);
      if(running) stop(); // إن كانت تعمل مسبقًا نوقفها أول ثم نعيد التشغيل (أمان)
      running = true;
      toggleBtn.textContent = "إيقاف";
      toggleBtn.classList.add("active");

      // ضبط العداد والمؤقتات
      remaining = sec;
      updateCountdownDisplay();

      // ابدأ العد التنازلي (tick) الذي يحدث كل ثانية في واجهة المستخدم
      startTick();

      // ابدأ تنفيذ الفحوصات الدورية
      checkAll(); // فحص فوري عند الضغط أول مرة
      checkHandle = setInterval(checkAll, sec * 1000);
    }

    function stop(){
      running = false;
      toggleBtn.textContent = "تشغيل";
      toggleBtn.classList.remove("active");

      if(checkHandle){ clearInterval(checkHandle); checkHandle = null; }
      stopTick();
    }

    toggleBtn.addEventListener("click", ()=> running ? stop() : start());

    /********* تنظيف عند إغلاق الصفحة (اختياري) *********/
    window.addEventListener("beforeunload", ()=>{
      if(checkHandle) clearInterval(checkHandle);
      if(tickHandle) clearInterval(tickHandle);
    });
  </script>
</body>
</html>
